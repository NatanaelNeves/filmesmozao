{% extends "base.html" %}

{% block content %}
    <div class="stats-section"> {# Container geral da página de estatísticas #}
        <h2><i class="fas fa-chart-pie"></i> Nossas Estatísticas Cinematográficas <i class="fas fa-chart-bar"></i></h2>

        <div class="stats-grid">
            <div class="stat-card">
                <h3><i class="fas fa-film"></i> Total de Filmes Assistidos</h3>
                <p class="stat-number">{{ total_movies }}</p>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-bookmark"></i> Filmes Para Ver</h3>
                <p class="stat-number">{{ total_to_watch }}</p>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-star"></i> Nota Média</h3>
                <p class="stat-number">{{ '%.1f' | format(avg_rating) }}</p>
            </div>
        </div>

        {# ESTRUTURA CORRIGIDA PARA OS GRÁFICOS #}
        <div class="stats-section"> {# Card para o gráfico de Gêneros #}
            <h3><i class="fas fa-chart-line"></i> Distribuição de Gêneros</h3>
            <div class="chart-container"> {# Container APENAS para o canvas e mensagem de sem dados #}
                <canvas id="genreChart"></canvas>
                {# A mensagem de "sem dados" do JS será inserida aqui se necessário #}
            </div>
        </div>

        <div class="stats-section"> {# Card para o gráfico de Usuários #}
            <h3><i class="fas fa-users"></i> Filmes por Usuário</h3>
            <div class="chart-container"> {# Container APENAS para o canvas e mensagem de sem dados #}
                <canvas id="userChart"></canvas>
                {# A mensagem de "sem dados" do JS será inserida aqui se necessário #}
            </div>
        </div>

        <div class="stats-section">
            <h3><i class="fas fa-tags"></i> Top 5 Gêneros Assistidos</h3>
            {% if top_genres %}
                <ul class="stats-list">
                    {% for genre, count in top_genres %}
                        <li>
                            <span>{{ genre }}</span>
                            <span>{{ count }} filmes</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Nenhum gênero registrado ainda.</p> {# Esta <p> será estilizada pelo CSS padrão, não por .chart-container p #}
            {% endif %}
        </div>

        <div class="stats-section">
            <h3><i class="fas fa-users"></i> Filmes Registrados por Usuário (Lista)</h3>
            {% if movies_by_user %}
                <ul class="stats-list">
                    {% for user, count in movies_by_user %}
                        <li>
                            <span>{{ user.capitalize() }}</span>
                            <span>{{ count }} filmes</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Nenhum filme registrado por usuário ainda.</p>
            {% endif %}
        </div>

        <div class="stats-section">
            <h3><i class="fas fa-history"></i> Últimos Filmes Assistidos</h3>
            {% if recent_movies %}
                <ul class="stats-list">
                    {% for movie in recent_movies %}
                        <li>
                            <span>{{ movie.title }} ({{ movie.watched_date.strftime('%d/%m/%Y') }}) - Nota: {% if movie.rating is not none %}{{ '%.1f' | format(movie.rating) }}{% else %}N/A{% endif %}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Nenhum filme assistido recentemente.</p>
            {% endif %}
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="{{ url_for('index') }}" class="button-logout" style="width: auto; display: inline-block;"><i class="fas fa-arrow-left"></i> Voltar para a Lista de Filmes</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const genreLabels = [];
            const genreData = [];
            const topGenres = JSON.parse('{{ top_genres | tojson | safe }}'); // Adicionado |safe
            if (topGenres) {
                topGenres.forEach(item => {
                    genreLabels.push(item[0]);
                    genreData.push(item[1]);
                });
            }

            const userLabels = [];
            const userData = [];
            const moviesByUser = JSON.parse('{{ movies_by_user | tojson | safe }}'); // Adicionado |safe
            if (moviesByUser) {
                moviesByUser.forEach(item => {
                    userLabels.push(item[0].charAt(0).toUpperCase() + item[0].slice(1));
                    userData.push(item[1]);
                });
            }
            
            const pastelColors = [ /* Suas cores ... */ ];
            const borderColors = [ /* Suas cores ... */ ];

            // Gráfico de Gêneros (Pie Chart)
            const genreChartCanvas = document.getElementById('genreChart');
            if (genreChartCanvas && genreLabels.length > 0) {
                const genreCtx = genreChartCanvas.getContext('2d');
                new Chart(genreCtx, {
                    type: 'pie',
                    data: { /* ... seus dados ... */ },
                    options: { /* ... suas opções ... */ }
                });
            } else if (genreChartCanvas) {
                // Mensagem se não houver dados, o CSS .chart-container p vai estilizar
                const p = document.createElement('p');
                p.textContent = 'Adicione filmes assistidos para ver a distribuição de gêneros!';
                genreChartCanvas.parentNode.appendChild(p); // Adiciona o <p> ao .chart-container
                genreChartCanvas.remove(); // Remove o canvas vazio
            }

            // Gráfico de Filmes por Usuário (Bar Chart)
            const userChartCanvas = document.getElementById('userChart');
            if (userChartCanvas && userLabels.length > 0) {
                const userCtx = userChartCanvas.getContext('2d');
                new Chart(userCtx, {
                    type: 'bar',
                    data: { /* ... seus dados ... */ },
                    options: { /* ... suas opções ... incluindo a cor dos ticks com var(--light-text-color) ... */ }
                });
            } else if (userChartCanvas) {
                // Mensagem se não houver dados
                const p = document.createElement('p');
                p.textContent = 'Adicione filmes assistidos para ver quem assistiu mais!';
                userChartCanvas.parentNode.appendChild(p);
                userChartCanvas.remove();
            }
        });
    </script>
{% endblock %}